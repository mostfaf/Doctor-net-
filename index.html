<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="description" content="دكتور نت - أدوات احترافية لإعدادات MikroTik RouterOS" />
<meta name="author" content="مصطفى عاطف الشوري" />
<title>دكتور نت - أدوات مايكروتك</title>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" as="style" onload="this.rel='stylesheet'" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap');
* {
  box-sizing: border-box;
  font-family: 'Cairo', sans-serif;
  margin: 0; padding: 0;
  transition: all 0.2s ease-in-out;
}
body {
  background: linear-gradient(135deg, #004aad, #0073e6);
  color: #333;
  min-height: 100vh;
  font-size: 16px;
  line-height: 1.6;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 15px;
}
#wrap {
  max-width: 900px;
  width: 100%;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  padding: 30px 25px 80px 25px;
  margin-top: 20px;
  position: relative;
}
.logo-img {
  width: 150px; height: 150px;
  border-radius: 50%;
  display: block;
  margin: 0 auto 25px auto;
  border: 8px solid #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  filter: drop-shadow(0 0 5px #0073e6);
}
label {
  font-weight: 600;
  font-size: 17px;
  color: #004aad;
  display: block;
  margin-bottom: 8px;
}
select, input[type=text], textarea {
  width: 100%;
  padding: 12px 15px;
  margin-bottom: 18px;
  border: 1.8px solid #ccc;
  border-radius: 10px;
  font-size: 15px;
  background: #fff;
  outline-color: #004aad;
}
select:focus, input[type=text]:focus, textarea:focus {
  border-color: #0073e6;
  background: #eaf4ff;
}
button {
  width: 100%;
  padding: 16px;
  font-size: 17px;
  font-weight: 700;
  border: none;
  border-radius: 10px;
  background-color: #004aad;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,67,173,0.6);
  user-select: none;
}
button:hover:not(:disabled) {
  background-color: #003087;
  box-shadow: 0 6px 18px rgba(0,48,135,0.8);
}
button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
  box-shadow: none;
}
#answer-text {
  height: 280px;
  padding: 15px;
  border-radius: 10px;
  border: 1.8px solid #ccc;
  font-size: 14px;
  resize: none;
  direction: ltr;
  font-family: Consolas, monospace;
  white-space: pre-wrap;
  line-height: 1.4;
  color: #222;
  background: #fff;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.07);
}
#answer {
  margin-top: 25px;
  display: none;
}
#copy {
  margin-top: 12px;
  background-color: #28a745;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(40,167,69,0.6);
}
#copy:hover {
  background-color: #218838;
  box-shadow: 0 6px 18px rgba(33,136,56,0.9);
}
#error {
  display: none;
  margin: 15px 0;
  padding: 10px 15px;
  font-weight: 600;
  font-size: 15px;
  color: #dc3545;
  background-color: #f8d7da;
  border-radius: 8px;
  border: 1px solid #f5c6cb;
  text-align: center;
}
.warning-message {
  background-color: #fff3cd;
  color: #856404;
  padding: 15px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 25px;
  border: 1px solid #ffeeba;
  text-align: center;
  box-shadow: 0 2px 8px rgba(255,193,7,0.3);
}
.disclaimer, .footer {
  color: #fff;
  text-align: center;
  margin: 25px 0 10px 0;
  font-weight: 500;
  user-select: none;
}
.footer {
  margin-bottom: 40px;
}
.support-floating {
  position: fixed;
  bottom: 25px;
  left: 25px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.support-btn, .booking-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  background-color: #004aad;
  color: white;
  border-radius: 50px;
  padding: 12px 20px;
  font-weight: 600;
  font-size: 16px;
  box-shadow: 0 6px 20px rgba(0,67,173,0.7);
  cursor: pointer;
  text-decoration: none;
  user-select: none;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}
.support-btn:hover, .booking-btn:hover {
  background-color: #003087;
  box-shadow: 0 8px 28px rgba(0,48,135,0.9);
}
.support-btn i, .booking-btn i {
  font-size: 20px;
}
@media (max-width: 768px) {
  #wrap { padding: 30px 15px 80px 15px; }
  .logo-img { width: 120px; height: 120px; }
  button, select, input[type=text], textarea { font-size: 15px; padding: 12px; }
  #answer-text { height: 220px; }
}
@media (max-width: 480px) {
  .logo-img { width: 100px; height: 100px; }
  button, select, input[type=text], textarea { font-size: 14px; padding: 10px; }
  #answer-text { height: 180px; }
  .support-floating { bottom: 15px; left: 15px; gap: 10px; }
  .support-btn, .booking-btn { font-size: 14px; padding: 10px 18px; }
}
</style>
</head>
<body>
<div id="wrap" role="main" aria-label="موقع دكتور نت لأدوات مايكروتك">
  <header aria-label="رأس الصفحة">
    <img src="https://i.imgur.com/0PBLMuU.jpeg" alt="شعار دكتور نت" class="logo-img" loading="lazy" />
  </header>

  <main>
    <section class="content" aria-labelledby="tools-label">
      <div class="warning-message" role="alert" aria-live="polite">
        <strong>تنبيه مهم:</strong> دكتور نت غير مسؤول عن أي أضرار ناتجة عن الاستخدام الخاطئ لهذه الأدوات. يرجى مراجعة السكربتات بعناية قبل التطبيق.
      </div>

      <label for="tool" id="tools-label">اختر الأداة:</label>
      <select id="tool" aria-required="true" aria-invalid="false" aria-describedby="tool-desc">
        <option value="" disabled selected>-- اختر أداة --</option>
        <option value="simple-queue">مولد Simple Queue</option>
        <option value="queue-tree">مولد Queue Tree</option>
        <option value="pcq">مولد PCQ</option>
        <option value="load-balancing-pcc">موازنة الحمل PCC</option>
        <option value="load-balancing-ecmp">موازنة الحمل ECMP</option>
        <option value="vpn-pptp">نفق VPN PPTP</option>
        <option value="firewall-basic">جدار حماية أساسي</option>
        <option value="dhcp-server">خادم DHCP</option>
        <option value="hotspot-setup">إعداد Hotspot</option>
        <option value="general">سؤال عام</option>
      </select>

      <div id="inputs" aria-live="polite" aria-atomic="true"></div>

      <button id="submit" aria-describedby="error" disabled>إنشاء السكربت</button>

      <p id="error" role="alert" aria-live="assertive"></p>

      <div id="answer" aria-label="السكريبت الناتج">
        <textarea id="answer-text" readonly aria-readonly="true" aria-label="نص السكربت الناتج"></textarea>
        <button id="copy" aria-label="نسخ السكربت">نسخ السكربت</button>
      </div>
    </section>
  </main>

  <footer class="disclaimer" aria-label="معلومات حقوق النشر">
    جميع الحقوق محفوظة لـ مصطفى عاطف الشوري برعاية سيستم سمارت راديوس © 2025
  </footer>
  <footer class="footer" aria-label="حقوق النشر">
    <p>تم تطوير الموقع لدعم مجتمع MikroTik بأفضل الأدوات والسكربتات.</p>
  </footer>
</div>

<div class="support-floating" aria-label="التواصل والدعم الفني">
  <button class="support-btn" id="supportBtn" aria-haspopup="dialog" aria-controls="supportModal" title="الدعم الفني المباشر">
    <i class="fas fa-headset"></i> دعم فني مباشر
  </button>
  <a href="https://mostfaf.github.io/Doctor-net/" target="_blank" rel="noopener" class="booking-btn" title="حجز موعد للدعم الفني">
    <i class="fas fa-calendar-check"></i> حجز موعد
  </a>
</div>

<dialog id="supportModal" aria-modal="true" role="dialog" aria-labelledby="supportTitle" aria-describedby="supportDesc">
  <h2 id="supportTitle">الدعم الفني المباشر</h2>
  <p id="supportDesc">يمكنك التواصل معنا مباشرة عبر الدردشة أو الفيديو لطلب الدعم الفني.</p>
  <div id="supportChat" style="height:300px; background:#f0f0f0; border-radius:8px; overflow-y:auto; padding:10px; font-family: monospace; font-size:14px;">
    <p><em>جاري تفعيل نظام الدعم الفني...</em></p>
  </div>
  <button id="closeSupport" aria-label="إغلاق الدعم الفني" style="margin-top:15px; padding:10px 20px; background:#004aad; color:#fff; border:none; border-radius:8px; cursor:pointer;">إغلاق</button>
</dialog>

<script>
  const toolsDatabase = {
    'simple-queue': {
      description: 'مولد Simple Queue لتحديد سرعة العملاء',
      inputs: [
        { id: 'ip', label: 'عنوان IP', placeholder: '192.168.1.2', type: 'text' },
        { id: 'speed', label: 'السرعة (تحميل/رفع)', placeholder: '2M/2M', type: 'text' },
        { id: 'name', label: 'اسم العميل', placeholder: 'client1', type: 'text' }
      ],
      repeatable: true,
      script: function(entries) {
        let script = '# Simple Queue Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += '/queue simple\n';
        entries.forEach((params, index) => {
          const ip = params.ip || `192.168.1.${index + 2}`;
          const speed = params.speed || '2M/2M';
          const name = params.name || `client${index + 1}`;
          script += `# Add queue for client: ${name}\n`;
          script += `add max-limit=${speed} name=${name} target=${ip}/32 comment="Generated by Dr. Net"\n`;
        });
        return script;
      }
    },
    'queue-tree': {
      description: 'مولد Queue Tree لإدارة النطاق الترددي',
      inputs: [
        { id: 'name', label: 'اسم Queue', placeholder: 'queue1', type: 'text' },
        { id: 'limit', label: 'الحد الأقصى', placeholder: '10M', type: 'text' },
        { id: 'parent', label: 'الأصل', placeholder: 'global', type: 'text' }
      ],
      repeatable: true,
      script: function(entries) {
        let script = '# Queue Tree Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += '/queue tree\n';
        entries.forEach((params, index) => {
          const name = params.name || `queue${index + 1}`;
          const limit = params.limit || '10M';
          const parent = params.parent || 'global';
          script += `# Add queue tree: ${name}\n`;
          script += `add name=${name} parent=${parent} max-limit=${limit} comment="Generated by Dr. Net"\n`;
        });
        return script;
      }
    },
    'pcq': {
      description: 'مولد PCQ لتوزيع النطاق الترددي بالتساوي',
      inputs: [
        { id: 'name', label: 'اسم PCQ', placeholder: 'pcq1', type: 'text' },
        { id: 'rate', label: 'السرعة لكل مستخدم', placeholder: '1M', type: 'text' }
      ],
      repeatable: true,
      script: function(entries) {
        let script = '# PCQ Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += '/queue type\n';
        entries.forEach((params, index) => {
          const name = params.name || `pcq${index + 1}`;
          const rate = params.rate || '1M';
          script += `# Add PCQ type: ${name}\n`;
          script += `add kind=pcq name=${name} pcq-rate=${rate} comment="Generated by Dr. Net"\n`;
        });
        script += '/queue tree\n';
        entries.forEach((params, index) => {
          const name = params.name || `pcq${index + 1}`;
          script += `# Add queue tree for PCQ: ${name}\n`;
          script += `add name=${name} parent=global queue=${name} comment="Generated by Dr. Net"\n`;
        });
        return script;
      }
    },
    'load-balancing-pcc': {
      description: 'موازنة الحمل PCC لتوزيع الحمل مع واجهة LAN واحدة',
      inputs: [
        { id: 'lanInterface', label: 'واجهة LAN', placeholder: 'ether2', type: 'text' },
        { id: 'wanIp', label: 'عنوان IP لـ WAN', placeholder: '192.168.1.2', type: 'text' },
        { id: 'wanGw', label: 'بوابة WAN', placeholder: '192.168.1.1', type: 'text' },
        { id: 'wanInterface', label: 'واجهة WAN', placeholder: 'ether1', type: 'text' }
      ],
      repeatable: true,
      script: function(entries) {
        let script = '# PCC Load Balancing Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += '# Configured for single LAN interface with multiple WANs\n\n';
        script += '/ip firewall mangle\n';
        entries.forEach((params, index) => {
          const wanInterface = params.wanInterface || `ether${index + 1}`;
          script += `# Mark connections for WAN${index + 1}\n`;
          script += `add chain=prerouting dst-address-type=!local in-interface=${params.lanInterface} per-connection-classifier=both-addresses:${entries.length}/${index} action=mark-connection new-connection-mark=wan${index + 1}_conn passthrough=yes comment="WAN${index + 1} PCC - Dr. Net"\n`;
          script += `add chain=prerouting connection-mark=wan${index + 1}_conn in-interface=${params.lanInterface} action=mark-routing new-routing-mark=to_wan${index + 1} passthrough=yes comment="WAN${index + 1} Routing - Dr. Net"\n`;
        });
        script += '\n/ip address\n';
        entries.forEach((params, index) => {
          script += `add address=${params.wanIp} interface=${params.wanInterface} comment="WAN${index + 1} - Dr. Net"\n`;
        });
        script += '\n/ip route\n';
        entries.forEach((params, index) => {
          script += `add dst-address=0.0.0.0/0 gateway=${params.wanGw} routing-mark=to_wan${index + 1} check-gateway=ping comment="WAN${index + 1} Route - Dr. Net"\n`;
        });
        script += '\n/ip firewall nat\n';
        entries.forEach((params, index) => {
          script += `add chain=srcnat out-interface=${params.wanInterface} action=masquerade comment="WAN${index + 1} NAT - Dr. Net"\n`;
        });
        return script;
      }
    },
    'vpn-pptp': {
      description: 'إنشاء نفق VPN PPTP بسيط',
      inputs: [
        { id: 'vpnUser', label: 'اسم المستخدم', placeholder: 'user1', type: 'text' },
        { id: 'vpnPass', label: 'كلمة المرور', placeholder: 'password', type: 'text' }
      ],
      repeatable: false,
      script: function(entries) {
        const user = entries[0].vpnUser || 'user1';
        const pass = entries[0].vpnPass || 'password';
        let script = '# VPN PPTP Setup Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += '/interface pptp-server server set enabled=yes\n';
        script += `/ppp secret add name=${user} password=${pass} service=pptp profile=default\n`;
        return script;
      }
    },
    'firewall-basic': {
      description: 'إعدادات جدار حماية أساسية',
      inputs: [],
      repeatable: false,
      script: function() {
        let script = '# Basic Firewall Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += '/ip firewall filter\n';
        script += 'add chain=input connection-state=established,related action=accept comment="Allow established/related"\n';
        script += 'add chain=input connection-state=invalid action=drop comment="Drop invalid"\n';
        script += 'add chain=input protocol=icmp action=accept comment="Allow ICMP"\n';
        script += 'add chain=input src-address=192.168.88.0/24 action=accept comment="Allow LAN"\n';
        script += 'add chain=input action=drop comment="Drop everything else"\n';
        return script;
      }
    },
    'dhcp-server': {
      description: 'إعداد خادم DHCP بسيط',
      inputs: [
        { id: 'interface', label: 'واجهة DHCP', placeholder: 'bridge-local', type: 'text' },
        { id: 'addressPool', label: 'نطاق العناوين', placeholder: 'dhcp_pool', type: 'text' },
        { id: 'gateway', label: 'بوابة الشبكة', placeholder: '192.168.88.1', type: 'text' }
      ],
      repeatable: false,
      script: function(entries) {
        const iface = entries[0].interface || 'bridge-local';
        const pool = entries[0].addressPool || 'dhcp_pool';
        const gateway = entries[0].gateway || '192.168.88.1';
        let script = '# DHCP Server Setup Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += `/ip pool add name=${pool} ranges=192.168.88.10-192.168.88.254\n`;
        script += `/ip dhcp-server add address-pool=${pool} interface=${iface} lease-time=3d name=dhcp1\n`;
        script += `/ip dhcp-server network add address=192.168.88.0/24 gateway=${gateway}\n`;
        return script;
      }
    },
    'hotspot-setup': {
      description: 'إعداد Hotspot بسيط',
      inputs: [
        { id: 'interface', label: 'واجهة Hotspot', placeholder: 'bridge-local', type: 'text' },
        { id: 'addressPool', label: 'نطاق العناوين', placeholder: 'hotspot_pool', type: 'text' },
        { id: 'dnsName', label: 'اسم DNS', placeholder: 'hotspot.local', type: 'text' }
      ],
      repeatable: false,
      script: function(entries) {
        const iface = entries[0].interface || 'bridge-local';
        const pool = entries[0].addressPool || 'hotspot_pool';
        const dns = entries[0].dnsName || 'hotspot.local';
        let script = '# Hotspot Setup Script - Generated by Dr. Net\n';
        script += '# Author: مصطفى عاطف الشوري\n';
        script += `/ip pool add name=${pool} ranges=192.168.88.10-192.168.88.254\n`;
        script += `/ip hotspot add address-pool=${pool} interface=${iface} name=hotspot1 profile=default\n`;
        script += `/ip hotspot profile set hotspot1 dns-name=${dns}\n`;
        return script;
      }
    },
    'general': {
      description: 'سؤال عام أو طلب خاص',
      inputs: [
        { id: 'question', label: 'اكتب سؤالك أو طلبك هنا', placeholder: 'مثال: كيف أضيف قاعدة في الجدار الناري؟', type: 'textarea' }
      ],
      repeatable: false,
      script: function(entries) {
        return `# سؤال عام من المستخدم:\n# ${entries[0].question || ''}\n# يرجى التواصل مع الدعم الفني للمساعدة.`;
      }
    }
  };

  const toolSelect = document.getElementById('tool');
  const inputsDiv = document.getElementById('inputs');
  const submitBtn = document.getElementById('submit');
  const errorP = document.getElementById('error');
  const answerDiv = document.getElementById('answer');
  const answerText = document.getElementById('answer-text');
  const copyBtn = document.getElementById('copy');

  const supportBtn = document.getElementById('supportBtn');
  const supportModal = document.getElementById('supportModal');
  const closeSupportBtn = document.getElementById('closeSupport');
  const supportChat = document.getElementById('supportChat');

  let currentTool = null;
  let repeatableCount = 1;

  function createInputField(input, repeatIndex) {
    const wrapper = document.createElement('div');
    wrapper.className = 'input-group';
    wrapper.style.marginBottom = '15px';

    const label = document.createElement('label');
    label.htmlFor = `${input.id}-${repeatIndex}`;
    label.textContent = input.label;
    wrapper.appendChild(label);

    let inputElement;
    if (input.type === 'textarea') {
      inputElement = document.createElement('textarea');
      inputElement.rows = 3;
    } else {
      inputElement = document.createElement('input');
      inputElement.type = input.type || 'text';
    }
    inputElement.id = `${input.id}-${repeatIndex}`;
    inputElement.name = input.id;
    inputElement.placeholder = input.placeholder || '';
    inputElement.setAttribute('aria-label', input.label);
    inputElement.required = true;
    inputElement.style.width = '100%';
    inputElement.style.padding = '10px';
    inputElement.style.borderRadius = '8px';
    inputElement.style.border = '1px solid #ccc';
    inputElement.style.fontSize = '15px';
    wrapper.appendChild(inputElement);

    return wrapper;
  }

  function buildInputs(toolKey) {
    inputsDiv.innerHTML = '';
    errorP.style.display = 'none';
    answerDiv.style.display = 'none';
    submitBtn.disabled = true;
    repeatableCount = 1;

    if (!toolKey || !toolsDatabase[toolKey]) return;

    currentTool = toolsDatabase[toolKey];

    const desc = document.createElement('p');
    desc.style.fontWeight = '600';
    desc.style.marginBottom = '15px';
    desc.style.color = '#004aad';
    desc.textContent = currentTool.description || '';
    inputsDiv.appendChild(desc);

    if (currentTool.repeatable) {
      addRepeatableInputs();
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'add-btn';
      addBtn.textContent = 'إضافة مدخل جديد +';
      addBtn.style.backgroundColor = '#28a745';
      addBtn.style.color = 'white';
      addBtn.style.border = 'none';
      addBtn.style.padding = '10px 20px';
      addBtn.style.borderRadius = '8px';
      addBtn.style.cursor = 'pointer';
      addBtn.style.fontWeight = '600';
      addBtn.style.marginTop = '10px';
      addBtn.addEventListener('click', () => {
        repeatableCount++;
        addRepeatableInputs();
      });
      inputsDiv.appendChild(addBtn);
    } else {
      currentTool.inputs.forEach((input) => {
        inputsDiv.appendChild(createInputField(input, 0));
      });
    }

    submitBtn.disabled = false;
  }

  function addRepeatableInputs() {
    const groupWrapper = document.createElement('fieldset');
    groupWrapper.style.border = '1.5px dashed #ccc';
    groupWrapper.style.padding = '15px 20px';
    groupWrapper.style.marginBottom = '15px';
    groupWrapper.style.borderRadius = '10px';
    groupWrapper.setAttribute('aria-label', `مجموعة مدخلات رقم ${repeatableCount}`);

    const legend = document.createElement('legend');
    legend.textContent = `المدخل رقم ${repeatableCount}`;
    legend.style.fontWeight = '700';
    legend.style.color = '#004aad';
    groupWrapper.appendChild(legend);

    currentTool.inputs.forEach((input) => {
      groupWrapper.appendChild(createInputField(input, repeatableCount));
    });

    if (repeatableCount > 1) {
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'حذف هذه المجموعة -';
      removeBtn.style.backgroundColor = '#dc3545';
      removeBtn.style.color = 'white';
      removeBtn.style.border = 'none';
      removeBtn.style.padding = '8px 15px';
      removeBtn.style.borderRadius = '8px';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.fontWeight = '600';
      removeBtn.style.marginTop = '10px';
      removeBtn.addEventListener('click', () => {
        groupWrapper.remove();
        repeatableCount--;
        const fieldsets = inputsDiv.querySelectorAll('fieldset');
        fieldsets.forEach((fs, i) => {
          fs.querySelector('legend').textContent = `المدخل رقم ${i + 1}`;
        });
      });
      groupWrapper.appendChild(removeBtn);
    }

    const addBtn = inputsDiv.querySelector('button.add-btn');
    if (addBtn) {
      inputsDiv.insertBefore(groupWrapper, addBtn);
    } else {
      inputsDiv.appendChild(groupWrapper);
    }
  }

  function collectInputs() {
    if (!currentTool) return [];

    let entries = [];
    if (currentTool.repeatable) {
      const fieldsets = inputsDiv.querySelectorAll('fieldset');
      fieldsets.forEach((fs) => {
        let entry = {};
        currentTool.inputs.forEach((input) => {
          const el = fs.querySelector(`#${input.id}-${fieldsets.length > 1 ? fs.querySelector('legend').textContent.match(/\d+/)[0] : 1}`);
          if (el) entry[input.id] = el.value.trim();
        });
        entries.push(entry);
      });
    } else {
      let entry = {};
      currentTool.inputs.forEach((input) => {
        const el = inputsDiv.querySelector(`#${input.id}-0`);
        if (el) entry[input.id] = el.value.trim();
      });
      entries.push(entry);
    }
    return entries;
  }

  function validateInputs(entries) {
    for (const entry of entries) {
      for (const key in entry) {
        if (!entry[key]) {
          return `الرجاء تعبئة الحقل "${key}" في جميع المجموعات.`;
        }
      }
    }
    return '';
  }

  function generateScript() {
    errorP.style.display = 'none';
    answerDiv.style.display = 'none';
    answerText.value = '';

    const entries = collectInputs();
    const validationError = validateInputs(entries);
    if (validationError) {
      errorP.textContent = validationError;
      errorP.style.display = 'block';
      return;
    }

    try {
      const script = currentTool.script(entries);
      answerText.value = script;
      answerDiv.style.display = 'block';
      errorP.style.display = 'none';
    } catch (e) {
      errorP.textContent = 'حدث خطأ أثناء إنشاء السكربت. يرجى المحاولة مرة أخرى.';
      errorP.style.display = 'block';
      console.error(e);
    }
  }

  copyBtn.addEventListener('click', () => {
    answerText.select();
    answerText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(answerText.value).then(() => {
      alert('تم نسخ السكربت إلى الحافظة!');
    }).catch(() => {
      alert('فشل النسخ. يرجى النسخ يدوياً.');
    });
  });

  toolSelect.addEventListener('change', () => {
    buildInputs(toolSelect.value);
  });

  submitBtn.addEventListener('click', (e) => {
    e.preventDefault();
    generateScript();
  });

  supportBtn.addEventListener('click', () => {
    supportModal.showModal();
    supportChat.innerHTML = '<p>جاري تفعيل نظام الدعم الفني المباشر...</p>';
    setTimeout(() => {
      supportChat.innerHTML = '<p><strong>مرحباً! كيف يمكننا مساعدتك اليوم؟</strong></p>';
    }, 1500);
  });

  closeSupportBtn.addEventListener('click', () => {
    supportModal.close();
  });

  supportModal.addEventListener('click', (event) => {
    const rect = supportModal.getBoundingClientRect();
    if (
      event.clientX < rect.left ||
      event.clientX > rect.right ||
      event.clientY < rect.top ||
      event.clientY > rect.bottom
    ) {
      supportModal.close();
    }
  });

  submitBtn.disabled = true;
</script>
</body>
</html>
